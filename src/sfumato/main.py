# generated by Gemini 3 Pro
import numpy as np
import soundfile as sf
from scipy import signal
import math
import os
import sys
import time
import random

from sfumato import settings
from sfumato.transmitter import FmTransmitter
from sfumato.reciever import FmReceiver
from sfumato.utils.output_audio import save_audio


# ==========================================
# ğŸ¨ Radio UI System
# ==========================================
class RadioUI:
    # ANSI Colors
    RED = "\033[91m"
    GREEN = "\033[92m"
    YELLOW = "\033[93m"
    BLUE = "\033[94m"
    CYAN = "\033[96m"
    RESET = "\033[0m"
    BOLD = "\033[1m"
    DIM = "\033[2m"

    @staticmethod
    def header():
        """èµ·å‹•æ™‚ã®ASCIIã‚¢ãƒ¼ãƒˆè¡¨ç¤º"""
        os.system("cls" if os.name == "nt" else "clear")
        logo = r"""
{c}
_____  ______  _    _  __  __           _______   ____  
/ ____||  ____|| |  | ||  \/  |   /\    |__   __| / __ \ 
| (___  | |__   | |  | || \  / |  /  \      | |   | |  | |
\___ \ |  __|  | |  | || |\/| | / /\ \     | |   | |  | |
____) || |     | |__| || |  | |/ ____ \    | |   | |__| |
|_____/ |_|      \____/ |_|  |_/_/    \_\   |_|    \____/ 
{r}{d}  >>> SFUMATO SDR SIMULATOR v1.0 <<<{r}
""".format(c=RadioUI.CYAN, r=RadioUI.RESET, d=RadioUI.DIM)
        print(logo)
        time.sleep(1)

    @staticmethod
    def log(step, message, color=RESET):
        """ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã®ãƒ­ã‚°è¡¨ç¤º"""
        print(
            f"{RadioUI.DIM}[{time.strftime('%H:%M:%S')}]{RadioUI.RESET} {color}{step:<15}{RadioUI.RESET} : {message}"
        )
        time.sleep(0.3)

    @staticmethod
    def on_air_animation(duration=3):
        """ON AIRã®ç‚¹æ»…æ¼”å‡º"""
        print()
        for _ in range(duration * 2):
            sys.stdout.write(
                f"\r    {RadioUI.RED}{RadioUI.BOLD}â— ON AIR{RadioUI.RESET}   Transmitting...  "
            )
            sys.stdout.flush()
            time.sleep(0.5)
            sys.stdout.write(
                f"\r    {RadioUI.DIM}â—‹ ON AIR{RadioUI.RESET}   Transmitting...  "
            )
            sys.stdout.flush()
            time.sleep(0.5)
        print(
            f"\r    {RadioUI.RED}{RadioUI.BOLD}â— ON AIR{RadioUI.RESET}   Transmission Stable.    \n"
        )

    @staticmethod
    def tuning_animation():
        """ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆé¸å±€ï¼‰æ¼”å‡º"""
        print(f"{RadioUI.YELLOW}Scanning Frequencies...{RadioUI.RESET}")
        target_freq = 80.0
        current_freq = 76.0

        while current_freq < target_freq:
            noise_level = random.choice(["â–‚", "â–ƒ", "â–…", " ", " "])
            sys.stdout.write(
                f"\r  ğŸ“» Tuning... {current_freq:.1f} MHz {RadioUI.DIM}[{noise_level * 5}]{RadioUI.RESET}"
            )
            sys.stdout.flush()
            current_freq += 0.1
            time.sleep(0.05)

        print(
            f"\r  {RadioUI.GREEN}âœ” LOCKED SIGNAL{RadioUI.RESET} {target_freq:.1f} MHz {RadioUI.GREEN}[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]{RadioUI.RESET}    \n"
        )

    @staticmethod
    def signal_meter(snr):
        """ä¿¡å·å¼·åº¦ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤º"""
        bars = int(snr / 5)  # 5dBã”ã¨ã«1ãƒ¡ãƒ¢ãƒª
        meter = "â–ˆ" * bars + "â–‘" * (10 - bars)
        color = (
            RadioUI.GREEN if snr > 20 else (RadioUI.YELLOW if snr > 10 else RadioUI.RED)
        )
        print(f"  Signal Strength: {color}[{meter}]{RadioUI.RESET} SNR: {snr}dB")

    @staticmethod
    def reception_success(filename):
        """å—ä¿¡æˆåŠŸæ™‚ã®ãƒ¬ãƒˆãƒ­ãªãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤æ¼”å‡º"""
        print(
            f"\n{RadioUI.GREEN}{RadioUI.BOLD}   >>> SIGNAL LOCKED! <<<   {RadioUI.RESET}\n"
        )
        time.sleep(0.5)

        # æ ã®ãƒ‡ã‚¶ã‚¤ãƒ³
        width = 50
        print(f"{RadioUI.CYAN}â•”{'â•' * width}â•—{RadioUI.RESET}")

        # 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º (STEREOãƒ©ãƒ³ãƒ—ãªã©)
        status = f"{RadioUI.RED}â— STEREO{RadioUI.RESET}   {RadioUI.GREEN}â— TUNED{RadioUI.RESET}   {RadioUI.YELLOW}80.0 MHz{RadioUI.RESET}"
        # ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å«ã‚€ã®ã§é•·ã•è¨ˆç®—ã‚’èª¿æ•´ã—ã¦ä¸­å¤®å¯„ã›
        padding = 24  # æ‰‹å‹•èª¿æ•´ (è‰²ã®æ–‡å­—æ•°åˆ†)
        print(
            f"{RadioUI.CYAN}â•‘{RadioUI.RESET}   {status}      {RadioUI.CYAN}â•‘{RadioUI.RESET}"
        )

        print(f"{RadioUI.CYAN}â• {'â”€' * width}â•£{RadioUI.RESET}")

        # 2. æ›²åè¡¨ç¤º (Now Playing)
        display_name = os.path.basename(filename)
        if len(display_name) > 30:
            display_name = display_name[:27] + "..."
        print(
            f"{RadioUI.CYAN}â•‘{RadioUI.RESET}  NOW PLAYING: {RadioUI.BOLD}{display_name:<33}{RadioUI.RESET} {RadioUI.CYAN}â•‘{RadioUI.RESET}"
        )

        # 3. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (ç°¡æ˜“ç‰ˆ)
        print(
            f"{RadioUI.CYAN}â•‘{RadioUI.RESET}                                                  {RadioUI.CYAN}â•‘{RadioUI.RESET}"
        )

        # 5ãƒ•ãƒ¬ãƒ¼ãƒ ã ã‘å‹•ã‹ã™
        bars = [" ", "â–‚", "â–ƒ", "â–…", "â–†", "â–‡", "â–ˆ"]
        for _ in range(6):
            # ãƒ©ãƒ³ãƒ€ãƒ ãªé«˜ã•ã®ãƒãƒ¼ã‚’ç”Ÿæˆ
            eq = "".join([random.choice(bars) for _ in range(20)])
            # ä¸¡å´ã«é…ç½®
            visualizer = f"{RadioUI.GREEN}{eq}{RadioUI.RESET}      {RadioUI.GREEN}{eq}{RadioUI.RESET}"

            sys.stdout.write(
                f"\r{RadioUI.CYAN}â•‘{RadioUI.RESET}   {visualizer}   {RadioUI.CYAN}â•‘{RadioUI.RESET}"
            )
            sys.stdout.flush()
            time.sleep(0.15)

        print(f"\n{RadioUI.CYAN}â•š{'â•' * width}â•{RadioUI.RESET}")
        print(f"\n{RadioUI.DIM}   File saved to: {filename}{RadioUI.RESET}\n")


# ==========================================
# ğŸ›  Core Logic (Updated with UI)
# ==========================================


def load_and_preprocess_wav(filename: str, target_fs: int) -> np.ndarray:
    if not os.path.exists(filename):
        raise FileNotFoundError(f"File not found: {filename}")

    RadioUI.log(
        "PREPROCESS", f"Loading '{os.path.basename(filename)}'...", RadioUI.BLUE
    )

    # 1. èª­ã¿è¾¼ã¿
    data, fs = sf.read(filename)

    # 2. ã‚¹ãƒ†ãƒ¬ã‚ª -> ãƒ¢ãƒãƒ©ãƒ«å¤‰æ›
    if data.ndim > 1:
        data = data.mean(axis=1)

    # 3. ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
    if fs != target_fs:
        RadioUI.log("RESAMPLE", f"Converting {fs}Hz -> {target_fs}Hz", RadioUI.CYAN)
        gcd = math.gcd(target_fs, fs)
        up = target_fs // gcd
        down = fs // gcd
        data = signal.resample_poly(data, up, down)

    # 4. å‹å¤‰æ›ã¨æ­£è¦åŒ–
    data = data.astype(np.float32)
    max_val = np.abs(data).max()
    if max_val > 1.0:
        data = data / max_val

    return data


def add_awgn_channel(rf_signal: np.ndarray, snr_db: float) -> np.ndarray:
    RadioUI.log("CHANNEL", f"Applying Atmospheric Noise (AWGN)...", RadioUI.YELLOW)
    RadioUI.signal_meter(snr_db)

    signal_power = np.mean(rf_signal**2)
    snr_linear = 10 ** (snr_db / 10)
    noise_power = signal_power / snr_linear
    noise = np.random.normal(0, np.sqrt(noise_power), len(rf_signal))

    return rf_signal + noise


def main():
    # --- UIèµ·å‹• ---
    RadioUI.header()

    # --- è¨­å®š ---
    INPUT_FILE = "time-tone.wav"
    base_name = os.path.splitext(os.path.basename(INPUT_FILE))[0]
    OUTPUT_FILE = f"outputs/{base_name}_restored.wav"
    TARGET_SNR = 10.0

    # ãƒ†ã‚¹ãƒˆéŸ³æºç”Ÿæˆ
    if not os.path.exists(INPUT_FILE):
        RadioUI.log(
            "SYSTEM",
            "Input file missing. Generating Time Signal (JihÅ)...",
            RadioUI.YELLOW,
        )
        fs = 44100

        # --- æ™‚å ± (Time Signal) ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
        t_short = np.arange(0, 0.1, 1 / fs)
        beep_440 = 0.5 * np.sin(2 * np.pi * 440 * t_short)

        silence = np.zeros(int(0.9 * fs))

        t_long = np.arange(0, 2.0, 1 / fs)
        beep_880 = 0.5 * np.sin(2 * np.pi * 880 * t_long)

        # çµåˆ: [ãƒ”ãƒƒ+ç„¡éŸ³] Ã— 3å› + [ãƒãƒ¼ãƒ³]
        unit = np.concatenate([beep_440, silence])
        melody = np.concatenate([unit, unit, unit, beep_880])

        save_audio(melody, fs, INPUT_FILE)

    # --- 1. é€ä¿¡æ©Ÿ (Transmitter) ---
    print(f"\n{RadioUI.BOLD}--- [1] Transmitter Station ---{RadioUI.RESET}")
    audio_data = load_and_preprocess_wav(INPUT_FILE, settings.AUDIO_FS)

    RadioUI.log("MODULATION", "FM Modulation in progress...", RadioUI.BLUE)
    tx = FmTransmitter()
    rf_signal = tx.modulate(audio_data)

    # æ”¾é€é–‹å§‹æ¼”å‡º
    RadioUI.on_air_animation(duration=2)

    # --- 2. é€šä¿¡è·¯ (Channel) ---
    print(f"{RadioUI.BOLD}--- [2] Wireless Channel ---{RadioUI.RESET}")

    # ä¼æ¬é…å»¶æ¼”å‡º
    time.sleep(1)
    noisy_rf_signal = add_awgn_channel(rf_signal, TARGET_SNR)
    time.sleep(1)

    # --- 3. å—ä¿¡æ©Ÿ (Receiver) ---
    print(f"\n{RadioUI.BOLD}--- [3] Receiver Device ---{RadioUI.RESET}")

    # ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ¼”å‡º
    RadioUI.tuning_animation()

    RadioUI.log("DEMODULATION", "Quadrature Demodulation...", RadioUI.CYAN)
    rx = FmReceiver()
    demodulated_audio = rx.process(noisy_rf_signal)

    # --- 4. ä¿å­˜ ---
    print(f"\n{RadioUI.BOLD}--- [4] Output ---{RadioUI.RESET}")
    RadioUI.log("IO", f"Saving audio to {OUTPUT_FILE}", RadioUI.GREEN)
    save_audio(demodulated_audio, rx.audio_fs, OUTPUT_FILE, normalize=False, gain=0.2)

    RadioUI.reception_success(OUTPUT_FILE)


if __name__ == "__main__":
    main()
